@startuml lr2-architecture
skinparam classAttributeIconSize 0
namespace domain {

class Bank {
  -id: uuid
  -name: string
  -license: string
  +ID(): uuid 
  +Name(): string
  +License(): string
}

class Branch {
  -id: uuid
  -bankID: uuid
  -address: string
  -opened: bool
  +ID(): uuid
  +BankID(): uuid
  +Address(): string
  +Open()
  +Close()
  +IsOpened(): bool
}

class Client {
  -id: uuid
  -passport: string
  -fullName: string
  -active: bool
  +ID(): uuid
  +FullName(): string
  +Activate()
  +Deactivate()
  +IsActive(): bool
}

class Account {
  -id: uuid
  -number: string
  -clientID: uuid
  -balance: Money
  -status: AccountStatus
  +ID(): uuid
  +Number(): string
  +ClientID(): uuid
  +Status() : AccountStatus
  +Balance(): int
  +Deposit(amount: int)
  +Withdraw(amount: int): bool
  +ChageStatus(status: AccountStatus)
}

class SavingsAccount {
  -Account
  -BonusProgram: BonusProgram
  +Deposit(value: Money)
}

class CreditAccount {
  -Account
  -overdraftLimit: Money
  +Withdraw(amount: int): bool
  +CanWithdraw(value: Money): bool
  RedeemBonus(points: int) error 
}

class Transaction {
  -id: uuid
  -fromAccountID: uuid
  -toAccountID: uuid
  -amount: int
  -currency: string
  -status: string
  +ID(): uuid
  +Amount(): int
  +Currency(): string
  +Complete()
  +Fail()
  +IsCompleted(): bool
}

class Card {
  -id: uuid
  -number: string
  -accountID: uuid
  -active: bool
  +ID(): uuid
  +Number(): string
  +Activate()
  +Block()
  +IsActive(): bool
}

class Employee {
  -id: uuid
  -branchID: uuid
  -position: string
  -employed: bool
  +ID(): uuid
  +Hire()
  +Fire()
  +IsEmployed(): bool
}

class Loan {
  -id: uuid
  -clientID: uuid
  -amount: int
  -approved: bool
  +ID(): uuid
  +Approve()
  +Reject()
  +IsApproved(): bool
}

class ATM {
  -id: uuid
  -branchID: uuid
  -cash: int
  +ID(): uuid
  +BranchID(): uuid
  +Withdraw(amount: int): bool
  +Deposit(amount: int)
}

class Event {
  -id: uuid
  -aggregateID: uuid
  -type: string
  -occurredAt: datetime
  +ID(): uuid
  +AggregateID(): uuid
  +Type(): string
  +OccurredAt(): datetime
}

}

namespace "application/services" as app_services {
interface PaymentAccount {
  +ID(): uuid.UUID
  +ClientID(): uuid.UUID
  +Balance(): domain.Money
  +Deposit(money): error
  +Withdraw(money): error
}

interface Storage<K comparable, V any> {
	Save(k K, v V) error
	ByID(k K) (V, error)
	Delete(k K) error
}


interface AccountStorage {
  -Storage[uuid.UUID, PaymentAccount]
  +UpdateStatus(accountID, status): error
}

interface EventStorage {
  -Storage[uuid.UUID, domain.Event]
  +QueryAll(): []*Event
}

class PaymentService {
  -accounts AccountStorage
  +Deposit(amount domain.Money, accountID uuid.UUID) error
  +Withdraw(amount domain.Money, accountID uuid.UUID) error
  +ProcessTransaction(t *domain.Transaction) error
}
}

namespace application {
class TransferUseCase {
  -payments: services.PaymentService
	-events:   services.EventStorage
  +Execute(t *domain.Transaction) error 
}
class BonusRedeemUseCase {
  -accounts: services.AccountStorage
	-events:   services.EventStorage
}
}

namespace infrastructure {
class CacheStorage<K, V> {
  -mu:  sync.RWMutex
	-data: map[K]V
  +Save(k K, v V) error
	+ByID(k K) (V, error)
	+Delete(k K) error
}

class AccountCache {
  -CacheStorage[uuid.UUID, services.PaymentAccount]
  +UpdateStatus(accountID uuid.UUID, status domain.AccountStatus) error 
}

class EventCache {
  -CacheStorage[uuid.UUID, domain.Event]
  +QueryAll() []*domain.Event 
}
}

domain.Bank "1" -- "1..*" domain.Branch
domain.Bank "1" -- "0..*" domain.Client

domain.Branch "1" -- "0..*" domain.Employee
domain.Branch "1" -- "0..*" domain.ATM

domain.Client "1" -- "1..*" domain.Account
domain.Client "1" -- "0..*" domain.Loan

domain.Account "1" -- "0..*" domain.Card
domain.Account "1" -- "0..*" domain.Transaction 

domain.SavingsAccount *-- domain.Account
domain.CreditAccount *-- domain.Account
domain.SavingsAccount *-- domain.BonusProgram

app_services.PaymentAccount <|.. domain.Account
app_services.PaymentAccount <|.. domain.SavingsAccount
app_services.PaymentAccount <|.. domain.CreditAccount

app_services.AccountStorage <|.. infrastructure.AccountCache
app_services.EventStorage <|.. infrastructure.EventCache
infrastructure.AccountCache *-- infrastructure.CacheStorage
infrastructure.EventCache *-- infrastructure.CacheStorage

app_services.PaymentService --> app_services.AccountStorage

application.TransferUseCase --> app_services.PaymentService
application.TransferUseCase --> app_services.EventStorage

application.BonusRedeemUseCase --> app_services.AccountStorage
application.BonusRedeemUseCase --> app_services.EventStorage
@enduml
